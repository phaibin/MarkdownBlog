---
layout: post
title: How To Debug Memory Leaks with XCode and Instruments Tutorial
date: 2011-05-24 07:34
categories:
- iphone
tags: []
published: true
comments: true
---
<p><p>一篇介绍debug和查找内存泄露很好的入门文章，原文：<a href="http://www.raywenderlich.com/2696/how-to-debug-memory-leaks-with-xcode-and-instruments-tutorial">http://www.raywenderlich.com/2696/how-to-debug-memory-leaks-with-xcode-and-instruments-tutorial</a></p>
<p> </p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">No matter how well you understand memory management in Objective-C, from time to time you’re bound to make mistakes. But often there’s way too much code to search line-by-line for problems (unless you want your hair to turn gray!)</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Luckily, Apple has provided some great ways to help you find memory-related problems in your applications. Sometimes these tools scare new developers, but they’re actually pretty awesome and easy to use!</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">That’s what this tutorial is all about. You’ll get hands hands-on experience using XCode and Instruments to debug and detect memory related problems.</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">This tutorial assumes you are familiar with memory management in Objective-C. If you are still shaky on the subject, you may wish to read the <a href="http://www.raywenderlich.com/2657/memory-management-in-objective-c-tutorial">memory management tutorial</a>first.</p>
<h2 style="font-weight:bold;font-style:inherit;font-size:18px;font-family:inherit;vertical-align:baseline;color:#006837;border:0 initial initial;margin:0;padding:5px 0 15px;">Getting Started</h2>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Our goal in this tutorial is to check for and resolve any memory leaks in an example app that illustrates common memory-related mistakes. So to get started, download a <a href="http://d1xzuxjlafny7l.cloudfront.net/downloads/LeakyApp.zip">leaky app</a> that I’ve put together for this tutorial.</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Open up the app and run it in XCode. You’ll see a list of sushi in a table view. Try selecting several rows, and then – BOOM! You get the dreaded EXC_BAD_ACCESS error, and the debugger is no help:</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;"><a rel="attachment wp-att-2702" href="http://www.raywenderlich.com/2696/how-to-debug-memory-leaks-with-xcode-and-instruments-tutorial/exc_bad_access-2"><img class="alignnone size-full wp-image-2702 bordered" style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:1px solid #000000;margin:0;padding:0;" title="The dreaded EXC_BAD_ACCESS" src="http://d1xzuxjlafny7l.cloudfront.net/wp-content/uploads/2011/02/EXC_BAD_ACCESS1.jpg" alt="The dreaded EXC_BAD_ACCESS" width="305" height="563" /></a></p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">This can be very frustrating to many beginning developers, as it’s not clear where the problem is. Here’s the advice I generally give to developers when you hit an EXC_BAD_ACCESS error:</p>
<ol style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0 0 0 40px;padding:0;">
<li>Set the NSZombieEnabled argument in your executable options, which sometimes helps narrow down the cause</li>
<li>Run with Apple Instruments such as Leaks to look for memory issues</li>
<li>Set a breakpoint in your code and step through until you narrow down where it’s crashing</li>
<li>Tried and true “comment out code till it works” then backtrack from there :]</li>
</ol>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">So let’s try this out for ourselves by trying option #1 – turning on NSZombieEnabled.</p>
<h2 style="font-weight:bold;font-style:inherit;font-size:18px;font-family:inherit;vertical-align:baseline;color:#006837;border:0 initial initial;margin:0;padding:5px 0 15px;">Zombie Invasion!</h2>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Unfortunately, the NSZombieEnabled option has nothing to do with the zombie apocalypse, so you can put away your boomsticks and chainsaws :]</p>
<div id="attachment_2703" class="wp-caption alignnone" style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;width:510px;border:0 initial initial;margin:0 10px 10px;padding:10px 0 0 10px;"><a rel="attachment wp-att-2703" href="http://www.raywenderlich.com/2696/how-to-debug-memory-leaks-with-xcode-and-instruments-tutorial/shotgun"><img class="size-full wp-image-2703" style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0;" title="Sorry, it's not those kind of zombies!" src="http://d1xzuxjlafny7l.cloudfront.net/wp-content/uploads/2011/02/Shotgun.jpg" alt="Sorry, it's not those kind of zombies!" width="500" height="332" /></a>
<p class="wp-caption-text" style="font-weight:inherit;font-style:inherit;font-size:smaller;font-family:'Helvetica Neue', Arial, Helvetica, sans-serif;vertical-align:baseline;color:#aeaeae;text-align:center;border:0 initial initial;margin:0;padding:0 0 5px;">Sorry, it's not those kind of zombies! Image credit: werewolf from sxc.hu.</p>
</div>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">NSZombieEnabled is a flag that you can enable that will provide a warning when you try to access an object that has been deallocated. And since accessing deallocated memory is one of the most common reasons for crashing, this is a good thing to try first.</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">To set this up, expand the Executables group in your sidebar in XCode, and double click the PropMemFun executable. Select the Arguments tab, go to the “Variables to be set in the environment” section, and click the Plus button. Set the name of the variable to NSZombieEnabled, and set the value to YES, as follows:</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;"><a rel="attachment wp-att-2704" href="http://www.raywenderlich.com/2696/how-to-debug-memory-leaks-with-xcode-and-instruments-tutorial/nszombieenabled"><img class="alignnone size-full wp-image-2704" style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0;" title="How To Turn On NSZombieEnabled" src="http://d1xzuxjlafny7l.cloudfront.net/wp-content/uploads/2011/02/NSZombieEnabled.jpg" alt="How To Turn On NSZombieEnabled" width="498" height="590" /></a></p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Now run the app, and click on a few rows again until it crashes. Go to your console log, and you’ll see the following message:</p>
<pre style="font-weight:bold;font-style:inherit;font-size:13px;font-family:'Courier New', Courier, Monaco, monospace;vertical-align:baseline;color:#333333;border:0 initial initial;margin:0 0 20px;padding:5px;">2011-02-03 12:07:44.778 PropMemFun[27224:207] ***
-[CFString respondsToSelector:]: message sent to deallocated instance ...
</pre>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">The program will also halt on the exact line where it’s crashing now. You can go up the backtrace to find the exact line where it’s crashing by selecting the first area in the backtrace that is your code – in this case tableView:didSelectRowAtIndexPath.</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;"><a rel="attachment wp-att-2705" href="http://www.raywenderlich.com/2696/how-to-debug-memory-leaks-with-xcode-and-instruments-tutorial/crashlocation"><img class="alignnone size-full wp-image-2705" style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0;" title="Crash Location found with NSZombieEnabled" src="http://d1xzuxjlafny7l.cloudfront.net/wp-content/uploads/2011/02/CrashLocation.jpg" alt="Crash Location found with NSZombieEnabled" width="484" height="638" /></a></p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Aha! Now you know that in this line, a message is being sent to a deallocated string. This line uses two strings: _lastSushiSelected, and sushiString.</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Well sushiString looks OK, because it’s initialized with stringWithFormat (which returns an autorelease variable), so it should be safe to use until the next run loop. But what about _lastSushiSelected?</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">_lastSushiSelected was set the last time this method was run to sushiString. But sushiString is an autorelease variable, so at some point it will be released, and the memory will be deallocated. But then _lastSushiSelected would still be pointing to deallocated memory! Which explains the problem – sending a message to deallocated memory causes a crash.</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">So to solve this, we just need to retain _lastSushiSelected so that the memory doesn’t go away. So replace the last line with the following:</p>
<div class="wp_codebox" style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;text-align:left;color:#110000;width:595px;border:1px solid silver;margin:0 0 .5em;padding:0;">
<table style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;width:594px;border:1px none initial;margin:0!important;padding:0;">
<tbody>
<tr style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0;">
<td class="code" style="font-weight:normal;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:top;text-align:center;margin:0;padding:2px 4px;">
<pre style="font-weight:inherit;font-style:inherit;font-size:12px;font-family:monospace;vertical-align:baseline;width:auto;float:none;text-align:left;border:0 none initial;margin:0;padding:0;">_lastSushiSelected <span style="font-weight:inherit;font-style:inherit;font-size:12px;font-family:inherit;vertical-align:baseline;color:#002200;border:0 initial initial;margin:0;padding:0;">=</span> <span style="font-weight:inherit;font-style:inherit;font-size:12px;font-family:inherit;vertical-align:baseline;color:#002200;border:0 initial initial;margin:0;padding:0;">[</span>sushiString retain<span style="font-weight:inherit;font-style:inherit;font-size:12px;font-family:inherit;vertical-align:baseline;color:#002200;border:0 initial initial;margin:0;padding:0;">]</span>;</pre>
</td>
</tr>
</tbody>
</table>
</div>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Compile and run your code, and now you should be able to run without crashing!</p>
<h2 style="font-weight:bold;font-style:inherit;font-size:18px;font-family:inherit;vertical-align:baseline;color:#006837;border:0 initial initial;margin:0;padding:5px 0 15px;">Build, Analyze, and Recognize</h2>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Ok, so we have an app that isn’t crashing – a good first step. But next, we need to start making sure that it isn’t leaking any memory.</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">There’s an easy way to perform an initial first-glance check on your app to see if it has any memory leaks or other problems – use the built-in Build and Analyze function.</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">This will make XCode run through your code and look for any mistakes it can automatically detect, and warn you about any potential problems. It doesn’t catch everything, but when it does catch things it’s a really quick and easy way to find out about the problems.</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Give it a shot by selecting BuildBuild and Analyze. You should see that it detected a memory leak, as you can see below:</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;"><a rel="attachment wp-att-2706" href="http://www.raywenderlich.com/2696/how-to-debug-memory-leaks-with-xcode-and-instruments-tutorial/buildandanalyzeleak"><img class="alignnone size-full wp-image-2706" style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0;" title="Leak found with Build and Analyze" src="http://d1xzuxjlafny7l.cloudfront.net/wp-content/uploads/2011/02/BuildAndAnalyzeLeak.jpg" alt="Leak found with Build and Analyze" width="500" height="25" /></a></p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">The message says that there’s a potential leak related to the “alertView”. If you look at this line, you’ll see that the UIAlertView was created with a alloc/init (which returns an object with a reference count of 1), but never released! There are several ways to fix this, but one way is to add the following after [alertView show]:</p>
<div class="wp_codebox" style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;text-align:left;color:#110000;width:595px;border:1px solid silver;margin:0 0 .5em;padding:0;">
<table style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;width:594px;border:1px none initial;margin:0!important;padding:0;">
<tbody>
<tr style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0;">
<td class="code" style="font-weight:normal;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:top;text-align:center;margin:0;padding:2px 4px;">
<pre style="font-weight:inherit;font-style:inherit;font-size:12px;font-family:monospace;vertical-align:baseline;width:auto;float:none;text-align:left;border:0 none initial;margin:0;padding:0;"><span style="font-weight:inherit;font-style:inherit;font-size:12px;font-family:inherit;vertical-align:baseline;color:#002200;border:0 initial initial;margin:0;padding:0;">[</span>alertView release<span style="font-weight:inherit;font-style:inherit;font-size:12px;font-family:inherit;vertical-align:baseline;color:#002200;border:0 initial initial;margin:0;padding:0;">]</span>;</pre>
</td>
</tr>
</tbody>
</table>
</div>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Go to BuildBuild and Analyze again, and you’ll see that there are no remaining issues.</p>
<h2 style="font-weight:bold;font-style:inherit;font-size:18px;font-family:inherit;vertical-align:baseline;color:#006837;border:0 initial initial;margin:0;padding:5px 0 15px;">Leaks and Plumbers</h2>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Unfortunately, you can’t rely on BuildBuild and Analyze to catch everything. There’s one other great automated tool to help you check your app for leaks – the Leaks Instrument.</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Let’s try it out. Go to RunRun with Performance ToolLeaks, and select a few rows in the table view. Also scroll up and down the table view from the top of the table to the bottom of the table. After bait of experimentation, you should start seeing some leaks popping up in the Leaks tab, which show up as blue bars.</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Click the stop button, then go to the toolbar in the middle and click it to change from “Leaked Blocks” to “Call Tree”. In the panel in the lower left, click “Invert Call Tree”, and “Hide System Libraries”. You’ll see that it found two different methods in the code with memory leaks, as you can see below:</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;"><a rel="attachment wp-att-2707" href="http://www.raywenderlich.com/2696/how-to-debug-memory-leaks-with-xcode-and-instruments-tutorial/foundleaks"><img class="alignnone size-full wp-image-2707" style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0;" title="Leaks found with Leaks Instrument" src="http://d1xzuxjlafny7l.cloudfront.net/wp-content/uploads/2011/02/FoundLeaks.jpg" alt="Leaks found with Leaks Instrument" width="500" height="484" /></a></p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">If you double click a function name, it will take you directly to the line of code that creates the object that was leaked. This should give you a really good hint where the problem lies, and if you examine the code and think about it a bit, you should be able to figure out what the problem is and fix it.</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">So why not take a look at the code and see if you can figure out what the problem is and fix it? Once you’ve made a fix, you can run Leaks again and verify that the leak no longer occurs. Come back here once you’ve finished, or gotten stuck!</p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">…<br />…waiting…<br />…<br />…waiitng…<br />…<br />…waiting…<br />…</p>
<div id="attachment_2108" class="wp-caption alignnone" style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;width:212px;border:0 initial initial;margin:0 10px 10px;padding:10px 0 0 10px;"><a rel="attachment wp-att-2108" href="http://www.raywenderlich.com/2106/core-graphics-101-arcs-and-paths/tsan_angry"><img class="size-full wp-image-2108" style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0;" title="Tomato-San is angry!" src="http://d1xzuxjlafny7l.cloudfront.net/wp-content/uploads/2010/09/Tsan_angry.jpg" alt="Tomato-San is angry!" width="202" height="240" /></a>
<p class="wp-caption-text" style="font-weight:inherit;font-style:inherit;font-size:smaller;font-family:'Helvetica Neue', Arial, Helvetica, sans-serif;vertical-align:baseline;color:#aeaeae;text-align:center;border:0 initial initial;margin:0;padding:0 0 5px;">Tomato-San is angry!</p>
</div>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">What?! Are you still reading here?! You can do it – go ahead and try! :]</p>
<h2 style="font-weight:bold;font-style:inherit;font-size:18px;font-family:inherit;vertical-align:baseline;color:#006837;border:0 initial initial;margin:0;padding:5px 0 15px;">The Solution</h2>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;"><em>tableView:didSelectRowAtIndexPath</em></p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Leaks tells us that the string created and stored into sushiString is leaked. So let’s think through why this is, step by step:</p>
<ol style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0 0 0 40px;padding:0;">
<li>When sushiString is created, it’s created with stringWithFormat. This returns an object with a retain count of 1, and a pending autorelease.</li>
<li>In the last line in the method, you call retain on the sushiString (bumping the retain count up to 2) and store it into _lastSushiSelected.</li>
<li>Later on, the autorelease takes effect, decrementing the retain count to 1.</li>
<li>Next time the tableView:didSelectRowAtIndexPath method is called, you override the _lastSushiSelected variable with a pointer to a new string – without releasing the old one! So that old string still has a retain count of 1, and is never released.</li>
</ol>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">One solution to this is to add the following line before setting lastSushiSelected to the sushiString:</p>
<div class="wp_codebox" style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;text-align:left;color:#110000;width:595px;border:1px solid silver;margin:0 0 .5em;padding:0;">
<table style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;width:594px;border:1px none initial;margin:0!important;padding:0;">
<tbody>
<tr style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0;">
<td class="code" style="font-weight:normal;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:top;text-align:center;margin:0;padding:2px 4px;">
<pre style="font-weight:inherit;font-style:inherit;font-size:12px;font-family:monospace;vertical-align:baseline;width:auto;float:none;text-align:left;border:0 none initial;margin:0;padding:0;"><span style="font-weight:inherit;font-style:inherit;font-size:12px;font-family:inherit;vertical-align:baseline;color:#002200;border:0 initial initial;margin:0;padding:0;">[</span>_lastSushiSelected release<span style="font-weight:inherit;font-style:inherit;font-size:12px;font-family:inherit;vertical-align:baseline;color:#002200;border:0 initial initial;margin:0;padding:0;">]</span>;</pre>
</td>
</tr>
</tbody>
</table>
</div>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;"><em>tableView:cellForRowAtIndexPath</em></p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Just like in the previous method, a string that’s created and stored into a variable named sushiString is leaked. Here’s what’s going on:</p>
<ol style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0 0 0 40px;padding:0;">
<li>A new string is created with alloc/init.</li>
<li>This returns an object with a reference count of 1.</li>
<li>However, this reference count is never decremented, so there’s a memory leak!</li>
</ol>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">This could be solved in one of three ways:</p>
<ol style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0 0 0 40px;padding:0;">
<li>Call release on sushiString after setting the textLabel to the string.</li>
<li>Call autorelease on sushiString after creating it with alloc/init.</li>
<li>Instead of using alloc/init, use stringWithFormat, which returns a string already marked as autorelease.</li>
</ol>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;"><em>Plumb the Leaks!</em></p>
<p style="font-weight:inherit;font-style:inherit;font-size:13px;font-family:inherit;vertical-align:baseline;border:0 initial initial;margin:0;padding:0 0 10px;">Fix the above two problems, compile and run Leaks again, and verify that you no longer have any leaks in the app!</p></p>
